<% content_for :head do %>
  <script>
    function initializeSpotsMap() {
      window.googleMapsLoaded = true;
      window.dispatchEvent(new Event('maps-loaded'));  // イベント名を統一
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places&callback=initializeSpotsMap" async defer></script>
<% end %>

<div class="container" 
     data-controller="spots-registration" 
     data-spots-registration-travel-id-value="<%= @travel.id %>"
     data-spots-registration-total-days-value="<%= @total_days %>">
  
  <!-- 検索エリア -->
  <div class="search-area mb-4">
    <div class="d-flex align-items-center">
      <div class="search-box flex-grow-1 me-3">
        <input
          id="pac-input"
          class="form-control"
          type="text"
          placeholder="ここで検索"
        />
      </div>
      <div class="register-buttons">
        <button class="btn btn-success me-2" data-action="spots-registration#registerSpot" data-category="sightseeing">観光登録</button>
        <button class="btn btn-warning me-2" data-action="spots-registration#registerSpot" data-category="restaurant">食事処登録</button>
        <button class="btn btn-info" data-action="spots-registration#registerSpot" data-category="hotel">宿泊先登録</button>
      </div>
    </div>
  </div>

  <!-- マップエリア -->
  <div class="map-area mb-4">
    <div id="map" style="height: 400px;" data-spots-registration-target="map"></div>
  </div>

  <!-- スポットリストエリア -->
  <div class="spots-area mb-5">
    <div class="row">
      <div class="col-md-4">
        <div class="spot-section" data-category="sightseeing">
          <div class="spot-header bg-success text-white">観光スポット</div>
          <div class="spots-list" data-spots-registration-target="sightseeingList"></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="spot-section" data-category="restaurant">
          <div class="spot-header bg-warning text-white">食事処</div>
          <div class="spots-list" data-spots-registration-target="restaurantList"></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="spot-section" data-category="hotel">
          <div class="spot-header bg-info text-white">宿泊先</div>
          <div class="spots-list" data-spots-registration-target="hotelList"></div>
        </div>
      </div>
    </div>
  </div>
  <hr class="my-5">

  <!-- 旅程表エリア -->
  <h2 class="text-center mb-4">旅程表</h2>
  <div class="schedule-area mb-4">
    <% (1..@total_days).each do |day| %>
      <h2 class="mt-4 mb-3"><%= day %>日目</h2>
      <% Schedule.time_zones.keys.each do |time_zone| %>
        <div class="card mb-3">
          <div class="card-header <%= time_zone_color(time_zone) %>">
            <%= time_zone_label(time_zone) %>
          </div>
          <div class="schedule-list" 
              data-spots-registration-target="scheduleList"
              data-day="<%= day %>"
              data-time-zone="<%= time_zone %>">
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- 保存ボタン -->
  <div class="text-center">
    <button data-action="spots-registration#saveSchedules" class="btn btn-primary px-5">保存</button>
  </div>
</div>

<%= content_tag :div, "", 
    data: {
      spots_registration_existing_spots_value: @spots.to_json(
        only: [:id, :name, :category, :lat, :lng, :order_number, :day_number, :time_zone]
      )
    },
    style: "display: none;" 
%>
