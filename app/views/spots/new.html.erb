<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
  <script>
    function initializeSpotsMap() {
      window.googleMapsLoaded = true;
      window.dispatchEvent(new Event('maps-loaded'));
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places&callback=initializeSpotsMap" async defer></script>
<% end %>

<div class="container" 
     data-controller="spots-registration" 
     data-spots-registration-travel-id-value="<%= @travel.id %>"
     data-spots-registration-total-days-value="<%= @total_days %>">

  <div class="debug-info" style="margin: 20px; padding: 10px; border: 1px solid #ccc;">
    <h4>Debug Info</h4>
    <p>Total spots: <%= @spots.count %></p>
    <p>Scheduled spots: <%= @schedules.count %></p>
    <% @schedules.each do |spot| %>
      <p>
        <%= spot.name %> - 
        Day: <%= spot.schedule.day_number %>, 
        Time: <%= spot.schedule.time_zone %>
      </p>
    <% end %>
  </div>
  
  <!-- 検索エリア -->
  <div class="search-area mb-4">
    <div class="d-flex align-items-center">
      <div class="search-box flex-grow-1 me-3">
        <input
          id="pac-input"
          class="form-control"
          type="text"
          placeholder="ここで検索"
        />
      </div>
      <div class="register-buttons">
        <button class="btn btn-success me-2" data-action="spots-registration#registerSpot" data-category="sightseeing">観光登録</button>
        <button class="btn btn-warning me-2" data-action="spots-registration#registerSpot" data-category="restaurant">食事処登録</button>
        <button class="btn btn-info" data-action="spots-registration#registerSpot" data-category="hotel">宿泊先登録</button>
      </div>
    </div>
  </div>

  <!-- マップエリア -->
  <div class="map-area mb-4">
    <div id="map" style="height: 400px;" data-spots-registration-target="map"></div>
  </div>

  <!-- スポットリストエリア -->
  <div class="spots-area mb-5">
    <div class="row">
      <div class="col-md-4">
        <div class="spot-section" data-category="sightseeing">
          <div class="spot-header bg-success text-white">観光スポット</div>
          <div class="spots-list" data-spots-registration-target="sightseeingList"></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="spot-section" data-category="restaurant">
          <div class="spot-header bg-warning text-white">食事処</div>
          <div class="spots-list" data-spots-registration-target="restaurantList"></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="spot-section" data-category="hotel">
          <div class="spot-header bg-info text-white">宿泊先</div>
          <div class="spots-list" data-spots-registration-target="hotelList"></div>
        </div>
      </div>
    </div>
  </div>
  <hr class="my-5">

  <!-- 旅程表エリア -->
  <h2 class="text-center mb-4">旅程表</h2>
  <div class="schedule-area mb-4">
    <% (1..@total_days).each do |day| %>
      <h2 class="mt-4 mb-3"><%= day %>日目</h2>
      <% Schedule.time_zones.keys.each do |time_zone| %>
        <div class="card mb-3">
          <div class="card-header <%= time_zone_color(time_zone) %>">
            <%= time_zone_label(time_zone) %>
          </div>
          <div class="schedule-list" 
              data-spots-registration-target="scheduleList"
              data-day="<%= day %>"
              data-time-zone="<%= time_zone %>">
            <% scheduled_spots = @schedules.select { |spot| 
                spot.schedule&.day_number == day && 
                spot.schedule&.time_zone == time_zone 
              }.sort_by { |spot| spot.schedule&.order_number || 0 } %>
            
            <% scheduled_spots.each do |spot| %>
              <%= render partial: 'spot', locals: { 
                spot: spot, 
                schedule: spot.schedule,
                show_number: true
              } %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- デバッグ表示を追加 -->
  <div style="display: none;">
    <p>Total spots: <%= @spots.count %></p>
    <p>Scheduled spots: <%= @schedules.count %></p>
    <% @schedules.each do |spot| %>
      <p><%= spot.name %>: Day <%= spot.schedule&.day_number %>, Time: <%= spot.schedule&.time_zone %></p>
    <% end %>
  </div>

  <!-- 保存ボタン -->
  <div class="text-center mt-4 mb-5">
    <button type="button" 
            class="btn btn-primary px-5"
            data-action="spots-registration#saveSchedules">
      保存
    </button>
  </div>
</div>

<%= content_tag :div, "", 
    data: {
      spots_registration_existing_spots_value: @spots_json
    },
    style: "display: none;" 
%>
